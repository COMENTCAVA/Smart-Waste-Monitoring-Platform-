{% extends 'base.html' %}

{% block title %}Carte géolocalisée{% endblock %}

{% block extra_head %}
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <!-- ➊ MarkerCluster CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
{% endblock %}

{% block fullpage %}
  <div class="d-flex" style="height: calc(100vh - 50px);">
    <div id="map-full" style="flex: 1;"></div>

    <div id="city-panel"
         class="p-3 bg-white border rounded"
         style="flex: 0 0 250px; max-width: 250px; overflow-y: auto;">

      <h5>{{ _('Votre position') }}</h5>
      <p id="city-name">{{ _('Chargement…') }}</p>

      <h6 class="mt-3">{{ _('Météo actuelle') }}</h6>
      <ul class="list-unstyled mb-0">
        <li>{{ _('Température') }} : <span id="weather-temp">–</span></li>
        <li>{{ _('Vent') }} : <span id="weather-wind">–</span></li>
        <li>{{ _('Condition') }} : <span id="weather-cond">–</span></li>
      </ul>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" defer></script>
  <!-- ➋ MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" defer></script>

  <script defer>
  document.addEventListener('DOMContentLoaded', () => {
    // 1) Initialisation carte
    const map = L.map('map-full').setView([48.8566, 2.3522], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:18
    }).addTo(map);

    // 2) Définition des icônes (inchangé)
    const marketIcon = L.icon({ iconUrl: '/static/images/market-icon.png', iconSize:[20,20], iconAnchor:[16,32], popupAnchor:[0,-32] });
    const zoneIcon   = L.icon({ iconUrl: '/static/images/zone-icon.png',   iconSize:[20,20], iconAnchor:[16,32], popupAnchor:[0,-32] });
    const chantierIcon = L.icon({ iconUrl: '/static/images/chantier-icon.png', iconSize:[20,20], iconAnchor:[16,32], popupAnchor:[0,-32] });
    const poubellePleineIcon = L.icon({ iconUrl: '/static/images/poubelle-pleine.png', iconSize:[20,20], iconAnchor:[16,32], popupAnchor:[0,-32] });
    const poubelleVideIcon   = L.icon({ iconUrl: '/static/images/poubelle-vide.png',   iconSize:[20,20], iconAnchor:[16,32], popupAnchor:[0,-32] });

    // 3) Création des groupes de clusters
    const imagesCluster   = L.markerClusterGroup();
    const marketsCluster  = L.markerClusterGroup();
    const zonesCluster    = L.markerClusterGroup();
    const chantiersCluster= L.markerClusterGroup();

    // 4) Chargement et ajout des marqueurs dans leurs clusters

    // 4.a) Images → poubelles
    fetch('/api/images?per_page=1000')
      .then(r=>r.json())
      .then(data=>{
        data.images.forEach(img=>{
          if (!img.latitude || !img.longitude) return;
          const icon = img.predicted_label==='Pleine'
                     ? poubellePleineIcon
                     : poubelleVideIcon;
          const m = L.marker([img.latitude, img.longitude], { icon })
            .bindPopup(`
              <img src="${img.url}" class="popup-thumb">
              <strong>${img.filename}</strong><br>
              Manuel : ${img.label||'–'}<br>
              Auto   : ${img.predicted_label||'–'}<br>
              Taille    : ${img.file_size||'–'} octets<br>
              Contraste : ${img.contrast||'–'}<br>
              Contours  : ${img.edges_count||'–'}
            `);
          imagesCluster.addLayer(m);
        });
        map.addLayer(imagesCluster);
      })
      .catch(console.error);


    // 4.c) Zones de rencontre
    fetch('https://opendata.paris.fr/api/explore/v2.1/catalog/datasets/zones-de-rencontre/records?limit=100')
    .then(r=>r.json())
    .then(data=>{
      data.results.forEach(rec=>{
        const { lat, lon } = rec.geo_point_2d;
        const m = L.marker([lat,lon], { icon: zoneIcon })
          .bindPopup(`
            <strong>${rec.nom_zca}</strong><br>
            1er Arrdt : ${rec.first_arrdt}<br>
            Date Arr. : ${rec.first_date_arr||'–'}<br>
            Arrêté    : ${rec.num_arrete||'–'}
          `);
        zonesCluster.addLayer(m);
      });
      map.addLayer(zonesCluster);
    })
    .catch(err=>console.error('Zones rencontre :',err));

    // 4.d) Chantiers
    fetch('https://opendata.paris.fr/api/explore/v2.1/catalog/datasets/chantiers-a-paris/records?limit=100')
    .then(r=>r.json())
    .then(data=>{
      data.results.forEach(rec=>{
        const { lat, lon } = rec.geo_point_2d;
        const m = L.marker([lat,lon], { icon: chantierIcon })
          .bindPopup(`
            <strong>${rec.chantier_categorie}</strong><br>
            Début : ${rec.date_debut}<br>
            Fin   : ${rec.date_fin}<br>
            Surface     : ${rec.surface} m²<br>
            MOA         : ${rec.moa_principal}<br>
            Synthèse    : ${rec.chantier_synthese}<br>
            Localisation: ${rec.localisation_detail.join(', ')}
          `);
        chantiersCluster.addLayer(m);
      });
      map.addLayer(chantiersCluster);
    })
    .catch(err=>console.error('Chantiers :',err));

    // 5) **Contrôle de couches** (cocher/décocher)
    const overlays = {
      "{{ _('Images (poubelles)') }}"  : imagesCluster,
      "{{ _('Marchés (aujourd’hui)') }}": marketsCluster,
      "{{ _('Zones rencontre') }}"     : zonesCluster,
      "{{ _('Chantiers') }}"           : chantiersCluster
    };
    L.control.layers(null, overlays, { collapsed:false })
     .addTo(map);

    // 6) Demande la position au navigateur (ne change pas le centre)
    map.locate({ setView: false, maxZoom: 14 });

    // 7) Quand on la trouve
    map.on('locationfound', (e) => {
      const lat = e.latlng.lat;
      const lon = e.latlng.lng;

      L.circleMarker([lat, lon], {
        radius:    12,         // rayon en pixels
        fillColor: 'red',
        fillOpacity: 0.8,
        stroke:    false,
        className: 'pulsing-circle'
      }).addTo(map);

      // 7.b) Reverse-geocoding (nom de la ville)
      fetch(
        `https://geocoding-api.open-meteo.com/v1/reverse` +
        `?latitude=${lat}&longitude=${lon}` +
        `&language={{ get_locale() }}&count=1`
      )
      .then(r => r.json())
      .then(d => {
        const p = d.results?.[0];
        if (p) {
          document.getElementById('city-name').textContent =
            `${p.name}, ${p.admin1}, ${p.country}`;
        }
      })
      .catch(() => {
        document.getElementById('city-name').textContent =
          '{{ _("Inconnue") }}';
      });

      // 7.c) Météo actuelle
      fetch(
        `https://api.open-meteo.com/v1/forecast` +
        `?latitude=${lat}&longitude=${lon}` +
        `&current_weather=true&timezone=auto`
      )
      .then(r => r.json())
      .then(d => {
        const w = d.current_weather;
        document.getElementById('weather-temp').textContent = `${w.temperature}°C`;
        document.getElementById('weather-wind').textContent = `${w.windspeed} km/h`;
        document.getElementById('weather-cond').textContent = w.weathercode;
      });
    });

    // 8) Erreur de géoloc
    map.on('locationerror', () => {
      document.getElementById('city-name').textContent =
        '{{ _("Position non disponible") }}';
    });

  });
  </script>
{% endblock %}